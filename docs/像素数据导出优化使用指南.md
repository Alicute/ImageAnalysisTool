# 像素数据导出模块优化使用指南

## 概述

新的 `ExportCompletePixelDataOptimizedAsync` 方法提供了以下优化：

1. **流式处理**：逐行处理像素，避免内存爆炸
2. **实时进度报告**：每1%进度更新一次
3. **取消支持**：可通过 CancellationToken 取消操作
4. **详细返回结果**：返回包含完整元信息的 ExportResult 对象
5. **增强的错误处理**：区分不同类型的错误

## 使用方法

### 基本用法

```csharp
// 创建处理器
var asyncProcessor = new AsyncImageProcessor();

// 订阅进度事件
asyncProcessor.ProgressChanged += (sender, e) => {
    // 在UI线程更新进度条
    this.Invoke((MethodInvoker)delegate {
        progressBar.Value = (int)e.ProgressPercentage;
        statusLabel.Text = e.Status;
    });
};

// 创建取消令牌源
var cts = new CancellationTokenSource();

// 异步导出
var result = await asyncProcessor.ExportCompletePixelDataOptimizedAsync(
    originalImage, 
    targetImage, 
    "txt", 
    cts.Token);

// 处理结果
if (result.Success)
{
    MessageBox.Show($"导出成功！\n文件: {result.FilePath}\n" +
                  $"大小: {result.GetFormattedFileSize()}\n" +
                  $"耗时: {result.Duration.TotalSeconds:F1}秒");
}
else if (result.Cancelled)
{
    MessageBox.Show("导出已被用户取消");
}
else
{
    MessageBox.Show($"导出失败: {result.ErrorMessage}");
}
```

### 高级用法 - 支持取消

```csharp
private CancellationTokenSource exportCts;

private async void StartExportWithCancel()
{
    // 创建取消令牌
    exportCts = new CancellationTokenSource();
    
    // 启用取消按钮
    cancelExportBtn.Enabled = true;
    
    try
    {
        var result = await asyncProcessor.ExportCompletePixelDataOptimizedAsync(
            originalImage, 
            targetImage, 
            "csv", 
            exportCts.Token,
            chunkSize: 50000); // 自定义分块大小
            
        // 处理结果...
    }
    catch (OperationCanceledException)
    {
        // 用户取消操作
    }
    finally
    {
        exportCts?.Dispose();
        exportCts = null;
        cancelExportBtn.Enabled = false;
    }
}

private void CancelExport_Click(object sender, EventArgs e)
{
    exportCts?.Cancel();
    statusLabel.Text = "正在取消导出...";
}
```

### 进度监控

```csharp
asyncProcessor.ProgressChanged += (sender, e) => {
    // 更新进度条
    progressBar.Value = (int)e.ProgressPercentage;
    
    // 显示详细状态
    statusLabel.Text = e.Status;
    
    // 计算剩余时间（简单估算）
    if (e.ProgressPercentage > 0)
    {
        var elapsed = DateTime.Now - startTime;
        var total = TimeSpan.FromMilliseconds(elapsed.TotalMilliseconds * 100 / e.ProgressPercentage);
        var remaining = total - elapsed;
        
        timeLabel.Text = $"剩余时间: {remaining.Minutes:D1}:{remaining.Seconds:D2}";
    }
};
```

## 性能优化建议

1. **分块大小调整**
   - 默认值：100,000 像素
   - 大图像（>1000万像素）：可增大至 500,000
   - 小图像（<100万像素）：可减小至 50,000

2. **内存优化**
   - 新版本使用流式处理，内存占用恒定
   - 不再需要一次性加载所有像素到内存

3. **并行处理**
   - 像素统计计算使用并行处理提高速度
   - 文件写入保持顺序以确保数据完整性

## 错误处理

新版本提供了更详细的错误信息：

```csharp
if (!result.Success)
{
    switch (result.ErrorMessage)
    {
        case string msg when msg.Contains("原图不能为空"):
            // 处理原图为空的情况
            break;
        case string msg when msg.Contains("目标图不能为空"):
            // 处理目标图为空的情况
            break;
        case string msg when msg.Contains("尺寸不匹配"):
            // 处理图像尺寸不匹配的情况
            break;
        default:
            // 处理其他错误
            break;
    }
}
```

## 迁移指南

### 从旧版本迁移

**旧版本：**
```csharp
string filePath = await asyncProcessor.ExportCompletePixelDataAsync(original, target, "txt");
```

**新版本：**
```csharp
var result = await asyncProcessor.ExportCompletePixelDataOptimizedAsync(original, target, "txt");
string filePath = result.FilePath;
```

### 主要变化

1. 返回值从 `string` 改为 `ExportResult`
2. 新增 `CancellationToken` 参数支持取消
3. 新增 `chunkSize` 参数可调整分块大小
4. 进度报告更频繁和准确
5. 错误处理更详细

## 注意事项

1. 大文件导出可能需要较长时间，建议提供取消功能
2. 确保有足够的磁盘空间存储导出文件
3. 在UI线程中使用时注意使用 Invoke 更新界面
4. 导出过程中避免修改原图或目标图