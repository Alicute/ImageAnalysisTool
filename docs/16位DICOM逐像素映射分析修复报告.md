# 16ä½DICOMå›¾åƒé€åƒç´ æ˜ å°„åˆ†æä¿®å¤æŠ¥å‘Š

## ğŸ” é—®é¢˜åˆ†æ

ç”¨æˆ·åé¦ˆåˆ†ææŠ¥å‘Šæ˜¾ç¤ºçš„æ˜ å°„ç‚¹å¾ˆå°‘ï¼Œä¾‹å¦‚ï¼š
```
åŸå€¼25856â†’æ–°å€¼16899(å˜åŒ–:-8957,-34.6%)
åŸå€¼25920â†’æ–°å€¼17067(å˜åŒ–:-8853,-34.2%)
...
```

åªæœ‰å°‘é‡æ˜ å°„ç‚¹ï¼Œè€Œä¸æ˜¯é¢„æœŸçš„750ä¸‡é€åƒç´ æ˜ å°„ã€‚

## ğŸ¯ æ ¹æœ¬åŸå› 

é€šè¿‡ä»£ç åˆ†æå‘ç°ï¼Œåœ¨`AnalyzePixelMapping`æ–¹æ³•ä¸­å­˜åœ¨åˆ†ç»„é€»è¾‘ï¼š

### ä¿®å¤å‰çš„é—®é¢˜ä»£ç 
```csharp
// æ£€æµ‹å›¾åƒä½æ·±
int maxOriginal = pixels.Max(p => p.OriginalValue);
int maxTarget = pixels.Max(p => p.TargetValue);
bool is16Bit = maxOriginal > 255 || maxTarget > 255;

// æ ¹æ®ä½æ·±ç¡®å®šåˆ†ç»„ç­–ç•¥
int binSize = is16Bit ? 64 : 1; // 16ä½å›¾åƒåˆ†ç»„ï¼Œ8ä½å›¾åƒä¸åˆ†ç»„

// åˆ†ç»„ç»Ÿè®¡
foreach (var pixel in pixels)
{
    int origKey = is16Bit ? (pixel.OriginalValue / binSize) * binSize : pixel.OriginalValue;
    int targetValue = pixel.TargetValue;
    // ...
}
```

**é—®é¢˜åˆ†æï¼š**
- 16ä½å›¾åƒä½¿ç”¨64å€¼åˆ†ç»„ï¼ˆbinSize = 64ï¼‰
- è¿™æ„å‘³ç€åŸå€¼0-63è¢«åˆ†ç»„åˆ°0ï¼Œ64-127è¢«åˆ†ç»„åˆ°64ï¼Œä»¥æ­¤ç±»æ¨
- 750ä¸‡ä¸ªåƒç´ è¢«å‹ç¼©æˆå¤§çº¦1000ä¸ªåˆ†ç»„ï¼ˆ65536/64 â‰ˆ 1024ï¼‰
- æŠ¥å‘Šåªæ˜¾ç¤ºå‰10ä¸ªã€ä¸­é—´10ä¸ªã€å10ä¸ªæ˜ å°„ç‚¹

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹AnalyzePixelMappingæ–¹æ³•

**ä¿®å¤å‰ï¼š**
```csharp
// æ ¹æ®ä½æ·±ç¡®å®šåˆ†ç»„ç­–ç•¥
int binSize = is16Bit ? 64 : 1; // 16ä½å›¾åƒåˆ†ç»„ï¼Œ8ä½å›¾åƒä¸åˆ†ç»„

// åˆ†ç»„ç»Ÿè®¡
foreach (var pixel in pixels)
{
    int origKey = is16Bit ? (pixel.OriginalValue / binSize) * binSize : pixel.OriginalValue;
    // ...
}
```

**ä¿®å¤åï¼š**
```csharp
// 16ä½DICOMå›¾åƒä½¿ç”¨é€åƒç´ æ˜ å°„ï¼Œä¸åˆ†ç»„
logger.Debug("ä½¿ç”¨16ä½DICOMé€åƒç´ ç²¾ç¡®æ˜ å°„æ¨¡å¼");

// é€åƒç´ ç»Ÿè®¡
foreach (var pixel in pixels)
{
    int origKey = pixel.OriginalValue;  // ç›´æ¥ä½¿ç”¨åŸå€¼ï¼Œä¸åˆ†ç»„
    int targetValue = pixel.TargetValue;
    // ...
}
```

### 2. ä¿®æ”¹æŠ¥å‘Šæ˜¾ç¤ºé€»è¾‘

**ä¿®å¤å‰ï¼š**
```csharp
// æ˜¾ç¤ºå‰10ä¸ªã€ä¸­é—´10ä¸ªã€å10ä¸ªæ˜ å°„ç‚¹
var keyPoints = new List<KeyValuePair<int, int>>();

// å‰10ä¸ª
keyPoints.AddRange(sortedMapping.Take(Math.Min(10, sortedMapping.Count)));

// ä¸­é—´10ä¸ª
if (sortedMapping.Count > 20)
{
    int midStart = (sortedMapping.Count - 10) / 2;
    keyPoints.AddRange(sortedMapping.Skip(midStart).Take(10));
}

// å10ä¸ª
if (sortedMapping.Count > 10)
{
    keyPoints.AddRange(sortedMapping.Skip(Math.Max(0, sortedMapping.Count - 10)));
}
```

**ä¿®å¤åï¼š**
```csharp
// 16ä½DICOMå›¾åƒæ˜ å°„å…³ç³»è¯¦ç»†åˆ†æ
int maxSamples = Math.Min(50, sortedMapping.Count);
int step = Math.Max(1, sortedMapping.Count / maxSamples);

analysis += $"    æ€»æ˜ å°„ç‚¹æ•°: {sortedMapping.Count}, æ˜¾ç¤ºé‡‡æ ·: {maxSamples} ä¸ªç‚¹\n";

for (int i = 0; i < sortedMapping.Count; i += step)
{
    var point = sortedMapping[i];
    // æ˜¾ç¤ºæ˜ å°„ç‚¹...
}
```

## âœ… ä¿®å¤æ•ˆæœ

### 1. æ˜ å°„ç²¾åº¦æå‡
- **ä¿®å¤å‰**ï¼š64å€¼åˆ†ç»„ï¼Œçº¦1024ä¸ªæ˜ å°„ç‚¹
- **ä¿®å¤å**ï¼šé€åƒç´ æ˜ å°„ï¼Œå¯è¾¾æ•°ä¸‡ä¸ªæ˜ å°„ç‚¹

### 2. æŠ¥å‘Šä¿¡æ¯é‡å¢åŠ 
- **ä¿®å¤å‰**ï¼šæ˜¾ç¤º30ä¸ªæ˜ å°„ç‚¹ï¼ˆå‰10+ä¸­10+å10ï¼‰
- **ä¿®å¤å**ï¼šæ˜¾ç¤º50ä¸ªé‡‡æ ·ç‚¹ + ç»Ÿè®¡æ‘˜è¦

### 3. åˆ†æå‡†ç¡®æ€§æå‡
- **ä¿®å¤å‰**ï¼šåˆ†ç»„å¹³å‡å¯èƒ½ä¸¢å¤±ç»†èŠ‚ä¿¡æ¯
- **ä¿®å¤å**ï¼šç²¾ç¡®åˆ°æ¯ä¸ªåƒç´ å€¼çš„æ˜ å°„å…³ç³»

## ğŸ“Š é¢„æœŸç»“æœå¯¹æ¯”

### ä¿®å¤åçš„æŠ¥å‘Šåº”è¯¥æ˜¾ç¤ºï¼š
```
=== 16ä½DICOMé€åƒç´ æ˜ å°„åˆ†æ ===
æ€»æ˜ å°„ç‚¹æ•°: 15,847, æ˜¾ç¤ºé‡‡æ ·: 50 ä¸ªç‚¹
    åŸå€¼0 â†’ æ–°å€¼0 (å˜åŒ–: +0, 0.0%)
    åŸå€¼256 â†’ æ–°å€¼198 (å˜åŒ–: -58, -22.7%)
    åŸå€¼512 â†’ æ–°å€¼445 (å˜åŒ–: -67, -13.1%)
    ...
    åŸå€¼65024 â†’ æ–°å€¼52147 (å˜åŒ–: -12877, -19.8%)
    åŸå€¼65280 â†’ æ–°å€¼52891 (å˜åŒ–: -12389, -19.0%)

æ˜ å°„ç»Ÿè®¡æ‘˜è¦:
    - æœ€å°åŸå€¼: 0, æœ€å¤§åŸå€¼: 65280
    - æœ€å°ç›®æ ‡å€¼: 0, æœ€å¤§ç›®æ ‡å€¼: 53891
    - å¹³å‡å˜åŒ–é‡: -3256.7
```

## ğŸ¯ æŠ€æœ¯æ”¹è¿›

### é€åƒç´ æ˜ å°„çš„ä¼˜åŠ¿
1. **ç²¾åº¦æå‡**ï¼šä¸å†ä½¿ç”¨åˆ†ç»„å¹³å‡ï¼Œä¿ç•™æ¯ä¸ªåƒç´ å€¼çš„ç²¾ç¡®æ˜ å°„
2. **ä¿¡æ¯å®Œæ•´**ï¼šèƒ½å¤Ÿæ•æ‰åˆ°ç»†å¾®çš„æ˜ å°„å˜åŒ–
3. **ç®—æ³•åˆ†æ**ï¼šä¸ºAIæä¾›æ›´å‡†ç¡®çš„ç®—æ³•é€†å‘åˆ†ææ•°æ®

### æ€§èƒ½è€ƒè™‘
- **å†…å­˜ä½¿ç”¨**ï¼šæ˜ å°„ç‚¹æ•°é‡å¢åŠ ï¼Œä½†ä»åœ¨å¯æ§èŒƒå›´å†…
- **å¤„ç†é€Ÿåº¦**ï¼šé€åƒç´ å¤„ç†é€Ÿåº¦ç¨æ…¢ï¼Œä½†ç²¾åº¦æ›´é‡è¦
- **æŠ¥å‘Šå¤§å°**ï¼šæ™ºèƒ½é‡‡æ ·é¿å…æŠ¥å‘Šè¿‡å¤§

## ğŸ” éªŒè¯å»ºè®®

1. **æµ‹è¯•å¤§å›¾åƒ**ï¼šä½¿ç”¨2432x3072çš„16ä½DICOMå›¾åƒ
2. **éªŒè¯æ˜ å°„ç‚¹æ•°**ï¼šåº”è¯¥æ˜¾ç¤ºæ•°åƒåˆ°æ•°ä¸‡çš„æ˜ å°„ç‚¹
3. **æ£€æŸ¥æŠ¥å‘Šå†…å®¹**ï¼šåº”è¯¥åŒ…å«è¯¦ç»†çš„æ˜ å°„ç»Ÿè®¡æ‘˜è¦
4. **å¯¹æ¯”ä¿®å¤å‰å**ï¼šæ˜ å°„ç²¾åº¦å’Œä¿¡æ¯é‡åº”æœ‰æ˜æ˜¾æå‡

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶é”å®š**ï¼šæµ‹è¯•æ—¶éœ€è¦å…³é—­åº”ç”¨ç¨‹åºæ‰èƒ½é‡æ–°ç¼–è¯‘
2. **å†…å­˜ä¼˜åŒ–**ï¼šå¯¹äºæå¤§å›¾åƒï¼Œæ˜ å°„å­—å…¸å¯èƒ½å ç”¨è¾ƒå¤šå†…å­˜
3. **æŠ¥å‘Šé•¿åº¦**ï¼š50ä¸ªé‡‡æ ·ç‚¹åœ¨ä¿¡æ¯é‡å’ŒæŠ¥å‘Šå¤§å°ä¹‹é—´å–å¾—å¹³è¡¡

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-08-06  
**ä¿®å¤æ–‡ä»¶**ï¼šPixelProcessor.cs  
**æ ¸å¿ƒæ”¹è¿›**ï¼šç§»é™¤64å€¼åˆ†ç»„ï¼Œå®ç°çœŸæ­£çš„é€åƒç´ ç²¾ç¡®æ˜ å°„  
**é¢„æœŸæ˜ å°„ç‚¹æ•°**ï¼šä»çº¦1000ä¸ªæå‡åˆ°æ•°ä¸‡ä¸ª