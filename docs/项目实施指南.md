# 图像处理工具项目实施指南

## 快速开始

### 环境准备
1. **安装Visual Studio 2022**
   - 选择".NET桌面开发"工作负载
   - 确保安装.NET 6.0或更高版本

2. **创建解决方案结构**
```bash
mkdir ImageProcessingTool
cd ImageProcessingTool
dotnet new sln -n ImageProcessingTool

# 创建项目
dotnet new classlib -n ImageProcessingTool.Core
dotnet new wpf -n ImageProcessingTool.UI
dotnet new xunit -n ImageProcessingTool.Tests

# 添加到解决方案
dotnet sln add ImageProcessingTool.Core
dotnet sln add ImageProcessingTool.UI  
dotnet sln add ImageProcessingTool.Tests

# 添加项目引用
cd ImageProcessingTool.UI
dotnet add reference ../ImageProcessingTool.Core

cd ../ImageProcessingTool.Tests
dotnet add reference ../ImageProcessingTool.Core
```

### 第一步：创建核心数据模型

#### ImageData.cs
```csharp
using System;
using System.Windows.Media;
using System.Windows.Media.Imaging;

namespace ImageProcessingTool.Core.Models
{
    public class ImageData
    {
        public int Width { get; set; }
        public int Height { get; set; }
        public int Channels { get; set; }
        public byte[] PixelData { get; set; }
        public PixelFormat Format { get; set; }
        public string FilePath { get; set; }

        public ImageData(int width, int height, int channels = 3)
        {
            Width = width;
            Height = height;
            Channels = channels;
            PixelData = new byte[width * height * channels];
            Format = channels == 3 ? PixelFormats.Rgb24 : PixelFormats.Rgba32;
        }

        public ImageData Clone()
        {
            var clone = new ImageData(Width, Height, Channels)
            {
                FilePath = FilePath,
                Format = Format
            };
            Array.Copy(PixelData, clone.PixelData, PixelData.Length);
            return clone;
        }

        public BitmapSource ToBitmapSource()
        {
            return BitmapSource.Create(
                Width, Height, 96, 96, Format, null, PixelData, Width * Channels);
        }

        public static ImageData FromBitmapSource(BitmapSource source)
        {
            var stride = source.PixelWidth * ((source.Format.BitsPerPixel + 7) / 8);
            var pixels = new byte[source.PixelHeight * stride];
            source.CopyPixels(pixels, stride, 0);

            return new ImageData(source.PixelWidth, source.PixelHeight, 
                source.Format.BitsPerPixel / 8)
            {
                PixelData = pixels,
                Format = source.Format
            };
        }
    }
}
```

### 第二步：实现基础滤波器接口

#### IImageFilter.cs
```csharp
using System.Threading.Tasks;
using ImageProcessingTool.Core.Models;

namespace ImageProcessingTool.Core.Interfaces
{
    public interface IImageFilter
    {
        string Name { get; }
        string Description { get; }
        Task<ImageData> ApplyAsync(ImageData input, object parameters = null);
    }
}
```

#### GaussianBlurFilter.cs
```csharp
using System;
using System.Threading.Tasks;
using ImageProcessingTool.Core.Interfaces;
using ImageProcessingTool.Core.Models;

namespace ImageProcessingTool.Core.Algorithms.Filters
{
    public class GaussianBlurFilter : IImageFilter
    {
        public string Name => "高斯模糊";
        public string Description => "使用高斯核进行图像模糊处理";

        public async Task<ImageData> ApplyAsync(ImageData input, object parameters = null)
        {
            var sigma = parameters as float? ?? 1.0f;
            
            return await Task.Run(() =>
            {
                var kernel = GenerateGaussianKernel(sigma);
                var result = input.Clone();
                
                ApplyConvolution(input.PixelData, result.PixelData, 
                    kernel, input.Width, input.Height, input.Channels);
                
                return result;
            });
        }

        private float[,] GenerateGaussianKernel(float sigma)
        {
            int size = (int)(6 * sigma) | 1; // 确保是奇数
            if (size < 3) size = 3;
            
            var kernel = new float[size, size];
            int center = size / 2;
            float sum = 0;

            for (int i = 0; i < size; i++)
            {
                for (int j = 0; j < size; j++)
                {
                    int x = i - center;
                    int y = j - center;
                    kernel[i, j] = (float)(Math.Exp(-(x * x + y * y) / (2 * sigma * sigma)));
                    sum += kernel[i, j];
                }
            }

            // 归一化
            for (int i = 0; i < size; i++)
            {
                for (int j = 0; j < size; j++)
                {
                    kernel[i, j] /= sum;
                }
            }

            return kernel;
        }

        private void ApplyConvolution(byte[] src, byte[] dst, float[,] kernel, 
            int width, int height, int channels)
        {
            int kernelSize = kernel.GetLength(0);
            int offset = kernelSize / 2;

            for (int y = offset; y < height - offset; y++)
            {
                for (int x = offset; x < width - offset; x++)
                {
                    for (int c = 0; c < channels; c++)
                    {
                        float sum = 0;
                        
                        for (int ky = 0; ky < kernelSize; ky++)
                        {
                            for (int kx = 0; kx < kernelSize; kx++)
                            {
                                int px = x + kx - offset;
                                int py = y + ky - offset;
                                int index = (py * width + px) * channels + c;
                                sum += src[index] * kernel[ky, kx];
                            }
                        }
                        
                        int dstIndex = (y * width + x) * channels + c;
                        dst[dstIndex] = (byte)Math.Max(0, Math.Min(255, sum));
                    }
                }
            }
        }
    }
}
```

### 第三步：创建主窗口UI

#### MainWindow.xaml
```xml
<Window x:Class="ImageProcessingTool.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="图像处理工具" Height="600" Width="900">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 菜单栏 -->
        <Menu Grid.Row="0">
            <MenuItem Header="文件">
                <MenuItem Header="打开" Click="OpenImage_Click"/>
                <MenuItem Header="保存" Click="SaveImage_Click"/>
                <Separator/>
                <MenuItem Header="退出" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="滤镜">
                <MenuItem Header="高斯模糊" Click="GaussianBlur_Click"/>
                <MenuItem Header="中值滤波" Click="MedianFilter_Click"/>
            </MenuItem>
        </Menu>
        
        <!-- 工具栏 -->
        <ToolBar Grid.Row="1">
            <Button Content="打开" Click="OpenImage_Click"/>
            <Button Content="保存" Click="SaveImage_Click"/>
            <Separator/>
            <Button Content="撤销" Click="Undo_Click"/>
            <Button Content="重做" Click="Redo_Click"/>
        </ToolBar>
        
        <!-- 主内容区域 -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- 功能面板 -->
            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="5">
                    <GroupBox Header="滤镜">
                        <StackPanel>
                            <Button Content="高斯模糊" Margin="2" Click="GaussianBlur_Click"/>
                            <Button Content="中值滤波" Margin="2" Click="MedianFilter_Click"/>
                        </StackPanel>
                    </GroupBox>
                    
                    <GroupBox Header="参数调节" x:Name="ParameterPanel">
                        <!-- 动态参数控件将在这里添加 -->
                    </GroupBox>
                </StackPanel>
            </ScrollViewer>
            
            <!-- 图像显示区域 -->
            <ScrollViewer Grid.Column="1" ZoomMode="Enabled" 
                         HorizontalScrollBarVisibility="Auto"
                         VerticalScrollBarVisibility="Auto">
                <Image x:Name="ImageDisplay" Stretch="None"/>
            </ScrollViewer>
        </Grid>
        
        <!-- 状态栏 -->
        <StatusBar Grid.Row="3">
            <StatusBarItem Content="{Binding ImageInfo}"/>
            <StatusBarItem Content="{Binding ProcessingStatus}"/>
            <StatusBarItem Content="{Binding ProcessingTime}"/>
        </StatusBar>
    </Grid>
</Window>
```

#### MainWindow.xaml.cs
```csharp
using System;
using System.IO;
using System.Windows;
using System.Windows.Media.Imaging;
using Microsoft.Win32;
using ImageProcessingTool.Core.Models;
using ImageProcessingTool.Core.Algorithms.Filters;

namespace ImageProcessingTool.UI
{
    public partial class MainWindow : Window
    {
        private ImageData _currentImage;
        private readonly GaussianBlurFilter _gaussianFilter;

        public MainWindow()
        {
            InitializeComponent();
            _gaussianFilter = new GaussianBlurFilter();
        }

        private void OpenImage_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new OpenFileDialog
            {
                Filter = "图像文件|*.jpg;*.jpeg;*.png;*.bmp;*.tiff|所有文件|*.*"
            };

            if (dialog.ShowDialog() == true)
            {
                try
                {
                    var bitmap = new BitmapImage(new Uri(dialog.FileName));
                    _currentImage = ImageData.FromBitmapSource(bitmap);
                    _currentImage.FilePath = dialog.FileName;
                    
                    ImageDisplay.Source = _currentImage.ToBitmapSource();
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"加载图像失败: {ex.Message}", "错误", 
                        MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private void SaveImage_Click(object sender, RoutedEventArgs e)
        {
            if (_currentImage == null)
            {
                MessageBox.Show("没有图像可保存", "提示");
                return;
            }

            var dialog = new SaveFileDialog
            {
                Filter = "PNG文件|*.png|JPEG文件|*.jpg|BMP文件|*.bmp"
            };

            if (dialog.ShowDialog() == true)
            {
                try
                {
                    var encoder = GetEncoder(Path.GetExtension(dialog.FileName));
                    encoder.Frames.Add(BitmapFrame.Create(_currentImage.ToBitmapSource()));
                    
                    using var stream = new FileStream(dialog.FileName, FileMode.Create);
                    encoder.Save(stream);
                    
                    MessageBox.Show("保存成功", "提示");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"保存失败: {ex.Message}", "错误");
                }
            }
        }

        private async void GaussianBlur_Click(object sender, RoutedEventArgs e)
        {
            if (_currentImage == null)
            {
                MessageBox.Show("请先打开图像", "提示");
                return;
            }

            try
            {
                var result = await _gaussianFilter.ApplyAsync(_currentImage, 2.0f);
                _currentImage = result;
                ImageDisplay.Source = _currentImage.ToBitmapSource();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"处理失败: {ex.Message}", "错误");
            }
        }

        private void MedianFilter_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("中值滤波功能待实现", "提示");
        }

        private void Undo_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("撤销功能待实现", "提示");
        }

        private void Redo_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("重做功能待实现", "提示");
        }

        private void Exit_Click(object sender, RoutedEventArgs e)
        {
            Close();
        }

        private BitmapEncoder GetEncoder(string extension)
        {
            return extension.ToLower() switch
            {
                ".png" => new PngBitmapEncoder(),
                ".jpg" or ".jpeg" => new JpegBitmapEncoder(),
                ".bmp" => new BmpBitmapEncoder(),
                _ => new PngBitmapEncoder()
            };
        }
    }
}
```

### 第四步：运行和测试

1. **编译项目**
```bash
dotnet build
```

2. **运行应用**
```bash
cd ImageProcessingTool.UI
dotnet run
```

3. **测试功能**
   - 打开一张图片
   - 点击"高斯模糊"按钮
   - 查看处理结果

## 下一步扩展

### 1. 添加更多滤波器
- 从D.cs中提取中值滤波算法
- 实现双边滤波
- 添加锐化滤波器

### 2. 改进用户界面
- 添加参数调节滑块
- 实现实时预览
- 添加进度条

### 3. 性能优化
- 使用并行处理
- 实现内存池
- 添加缓存机制

### 4. 功能完善
- 撤销/重做系统
- 批处理功能
- 插件架构

这个指南提供了一个完整的起始点，您可以按照步骤逐步构建自己的图像处理工具。
